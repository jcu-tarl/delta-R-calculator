var matrices = {
	location_only: [
		[1047.54443630433,-1885.39040923779,-823.088664403101,-0.562534792997392,2049.52844201186,1.00112471608693,0.332511202980178,-0.883036888798815],
		[-1885.39040923779,5723.9070944168,1972.90822129929,0.978426328366028,-6327.54649108579,-3.04808504247899,-0.844048855425761,2.76736331363973],
		[-823.088664403101,1972.90822129929,2106.37729826304,0.379536217718141,-4435.86819039074,-0.975056367293947,-1.16492141232554,2.31837686524314],
		[-0.562534792997392,0.978426328366028,0.379536217718141,0.000308943680611,-0.97825688834379,-0.000524279096313,-0.000139667970419,0.00040476460449],
		[2049.52844201186,-6327.54649108579,-4435.86819039074,-0.97825688834379,13111.790811357,3.17722550728485,2.3502084869384,-6.690738341949],
		[1.00112471608693,-3.04808504247899,-0.975056367293947,-0.000524279096313,3.17722550728485,0.001636097576176,0.000401437706642,-0.001357021969273],
		[0.332511202980178,-0.844048855425761,-1.16492141232554,-0.000139667970419,2.3502084869384,0.000401437706642,0.000680785665373,-0.001281357689115],
		[-0.883036888798815,2.76736331363973,2.31837686524314,0.00040476460449,-6.690738341949,-0.001357021969273,-0.001281357689115,0.003534551887903]
	],
	all: [
		[1000.55894819478,-1788.65249967043,-759.793569491251,-0.536321225224905,13.6298726103314,-0.913038433597944,2065.66614028288,0.93405095350915,0.312509044516556,-1.75927377176619,-0.928394018073839],
		[-1788.65249967043,5142.83610490906,1771.60920842475,0.92709934422005,-22.0710582201968,1.01866670142338,-5639.59349730693,-2.71421774121496,-0.776901217175216,-1.54383315448604,2.502720272434],
		[-759.793569491251,1771.60920842475,1681.86240190226,0.358208325003827,-1.15285466247656,2.84710696047539,-3690.96207607566,-0.881277583058071,-0.919258553132474,-1.40535130286676,1.90988893477834],
		[-0.536321225224905,0.92709934422005,0.358208325003827,0.000294013561949,-0.009192880390902,0.00032436800483,-1.02327499845651,-0.000486885189636,-0.000136452915644,0.000569672480275,0.000450118067933],
		[13.6298726103314,-22.0710582201968,-1.15285466247656,-0.009192880390902,5.73404680465112,-2.13190005238611,21.6984449683655,0.010601638819047,-0.003700096874532,-0.702646526009885,-0.010091406441948],
		[-0.913038433597944,1.01866670142338,2.84710696047539,0.00032436800483,-2.13190005238611,11.4283335346852,8.41188638896573,-0.001034315124793,0.00655602690588,-2.05253511087342,-0.005890261185466],
		[2065.66614028288,-5639.59349730693,-3690.96207607566,-1.02327499845651,21.6984449683655,8.41188638896573,11671.9323643646,2.81956441476122,1.92489855565641,-3.11185902421109,-5.94064454951234],
		[0.93405095350915,-2.71421774121496,-0.881277583058071,-0.000486885189636,0.010601638819047,-0.001034315124793,2.81956441476122,0.001443097332523,0.000376242667406,0.001452668558658,-0.001225640623963],
		[0.312509044516556,-0.776901217175216,-0.919258553132474,-0.000136452915644,-0.003700096874532,0.00655602690588,1.92489855565641,0.000376242667406,0.000538179608807,0.000681965109962,-0.001036183172493],
		[-1.75927377176619,-1.54383315448604,-1.40535130286676,0.000569672480275,-0.702646526009885,-2.05253511087342,-3.11185902421109,0.001452668558658,0.000681965109962,2.8349712515273,0.002772251961525],
		[-0.928394018073839,2.502720272434,1.90988893477834,0.000450118067933,-0.010091406441948,-0.005890261185466,-5.94064454951234,-0.001225640623963,-0.001036183172493,0.002772251961525,0.003116969188373]
	],
	no_O18: [
		[1124.02127319674,-2013.62614504343,-855.419263780764,-0.602868110680538,14.191717226379,2323.56023697486,1.05197717177895,0.353844083775367,-1.04361889295774],
		[-2013.62614504343,5785.57626282554,1992.50662848552,1.04349418872471,-25.2936522937299,-6347.29348268234,-3.05304414794048,-0.873642757713082,2.81762062778721],
		[-855.419263780764,1992.50662848552,1891.2048280974,0.403207545565821,-1.14229986382173,-4155.94088684265,-0.990773333474925,-1.03539404573022,2.15128458870563],
		[-0.602868110680538,1.04349418872471,0.403207545565821,0.000330622623103,-0.009964426342429,-1.15116003718009,-0.000548154567025,-0.000154273656674,0.000506152708422],
		[14.191717226379,-25.2936522937299,-1.14229986382173,-0.009964426342429,5.46666785420323,25.3869602165413,0.012338874550823,-0.001866293217833,-0.011741790950283],
		[2323.56023697486,-6347.29348268234,-4155.94088684265,-1.15116003718009,25.3869602165413,13124.6777354108,3.17424847720728,2.16175114124422,-6.6780565830861],
		[1.05197717177895,-3.05304414794048,-0.990773333474925,-0.000548154567025,0.012338874550823,3.17424847720728,0.00162288059592,0.000422926834905,-0.001380634821194],
		[0.353844083775367,-0.873642757713082,-1.03539404573022,-0.000154273656674,-0.001866293217833,2.16175114124422,0.000422926834905,0.000599730179613,-0.00116352615254],
		[-1.04361889295774,2.81762062778721,2.15128458870563,0.000506152708422,-0.011741790950283,-6.6780565830861,-0.001380634821194,-0.00116352615254,0.003502338346612]
	],
	no_C13: [
		[1065.94052120807,-1911.69404892639,-833.569872041171,-0.566450364758188,4.49155290174732,2217.49315882492,1.00074179313492,0.353763695758244,-0.995695866418202],
		[-1911.69404892639,5561.4927409851,1943.02221000449,0.980829446786836,-11.85032316328,-6118.00096964829,-2.93873953256946,-0.870658962699961,2.71533891549191],
		[-833.569872041171,1943.02221000449,1850.51520978948,0.392007065854836,1.22943914009091,-4059.22221631732,-0.966234140437477,-1.01278003468491,2.10150286975161],
		[-0.566450364758188,0.980829446786836,0.392007065854836,0.000307357748043,-0.003921977024477,-1.08842493780305,-0.000516733009669,-0.000156714682991,0.00047810926992],
		[4.49155290174732,-11.85032316328,1.22943914009091,-0.003921977024477,9.56564166784366,17.7239285892893,0.005751146868453,0.005915362874204,-0.009192922518924],
		[2217.49315882492,-6118.00096964829,-4059.22221631732,-1.08842493780305,17.7239285892893,12760.2983416364,3.06066627230877,2.13476830603002,-6.49831973471597],
		[1.00074179313492,-2.93873953256946,-0.966234140437477,-0.000516733009669,0.005751146868453,3.06066627230877,0.00156423449736,0.000421522840456,-0.001330579046908],
		[0.353763695758244,-0.870658962699961,-1.01278003468491,-0.000156714682991,0.005915362874204,2.13476830603002,0.000421522840456,0.000589885414563,-0.001148146533197],
		[-0.995695866418202,2.71533891549191,2.10150286975161,0.00047810926992,-0.009192922518924,-6.49831973471597,-0.001330579046908,-0.001148146533197,0.003411281087113]
	]
};

var coefficients = {
	location_only: [[
		-140.405216160,
		 -43.305516144,
		 -97.724922753,
		   0.008873205,
		   9.967426835,
		  -0.008975221,
		   0.049201735,
		  -0.026830853
	]],
	all: [[
 		 -99.35189637,
 		-108.62983816,   
 		-124.90234449,  
 		  -0.01137384, 
 		   3.76869645,
 		  -1.68008167, 
 		  88.87886964,  
 		   0.02188261,
 		   0.05531372,
 		  -6.94251872, 
 		  -0.06482373 
	]],
	no_O18: [[
 		-105.135221936,         
 		-112.477339958,           
 		-127.109726926,            
 		  -0.009481762,          
 		   0.266782914,         
 		  85.412718723,           
 		   0.025451781,         
 		   0.061739157,         
 		  -0.060654148         
	]],
	no_C13: [[
		-108.520124885,          
		-104.139656072,            
		-127.790929958,            
		  -0.006644573,          
		  -5.733827953,         
		  73.549730195,           
		   0.021402276,         
		   0.058284454,         
		  -0.054570716         
	]]
};

var coastal_coords = [[285,180],[318,144],[361,152],[387,121],[432,103],[478,109],[490,135],[499,169],[542,192],[578,186],[586,138],[601,92],[618,119],[645,154],[663,195],[685,234],[720,266],[752,299],[782,338],[797,383],[794,429],[775,473],[750,515],[729,560],[678,584],[636,571],[583,569],[549,533],[526,489],[492,503],[463,479],[417,455],[363,457],[308,467],[262,494],[204,494],[150,512],[121,484],[122,438],[103,394],[89,348],[95,301],[125,268],[174,253],[223,240],[248,198],[643,614],[705,617],[679,665],[638,77],[632,68],[126,255],[588,61],[653,642],[675,622],[542,145],[507,110],[551,98],[502,88],[394,92]];

function calculate(latitude, longitude, d13C, d18O){
	if(!latitude || !longitude){
		document.getElementById("result").innerHTML="<div class='alert alert-danger' role='alert'>You must select a point on the Australian coast</div>";
		return 0;
	}
	var coefs = [];
	var vcov = [];
	var predictors = [];
	const bfi = bearing(longitude, latitude);
	const sin_bfi = Math.sin(bfi);
	const cos_bfi = Math.cos(bfi);
	const dfi = distance(longitude, latitude);
	const sincos = sin_bfi * cos_bfi;
	const sindfi = sin_bfi * dfi;
	const cosdfi = cos_bfi * dfi;
	const CO = !d13C || !d18O ? null : d13C * d18O;
	const sincosdfi = sin_bfi * cos_bfi * dfi;

	switch(true){
		case !d13C && !!d18O: // d18O only
			predictors = [[1, sin_bfi, cos_bfi, dfi, d18O, sincos, sindfi, cosdfi, sincosdfi]];
			coefs = coefficients.no_C13;
			vcov = matrices.no_C13;
			break;
		case !!d13C && !d18O: // d13C only
			predictors = [[1, sin_bfi, cos_bfi, dfi, d13C, sincos, sindfi, cosdfi, sincosdfi]];
			coefs = coefficients.no_O18;
			vcov = matrices.no_O18;
			break;
		case !d13C && !d18O: // Location only
			predictors = [[1, sin_bfi, cos_bfi, dfi, sincos, sindfi, cosdfi, sincosdfi]];
			coefs = coefficients.location_only;
			vcov = matrices.location_only;
			break;
		default:
			predictors = [[1, sin_bfi, cos_bfi, dfi, d13C, d18O, sincos, sindfi, cosdfi, CO, sincosdfi]];
			coefs = coefficients.all;
			vcov = matrices.all;
	}
//	console.log(predictors);
//	console.log(coefs);
	const dR = MMult(predictors, transpose(coefs));
	const se = Math.sqrt(MMult(predictors, MMult(vcov, transpose(predictors))));
	document.getElementById("result").innerHTML=""
		+ "<div class='alert alert-success' role='alert'>&Delta;R: " + parseFloat(dR).toFixed(2) + "&nbsp;&nbsp;"
		+ "&epsilon;: " + parseFloat(se).toFixed(2) + "</div>";

}

function transpose(matrix) {
	return matrix[0].map((col, i) => matrix.map(row => row[i]));
}

function MMult (A, B) {
	var result = new Array(A.length).fill(0).map(row => new Array(B[0].length).fill(0));

	return result.map((row, i) => {
		return row.map((val, j) => {
			return A[i].reduce((sum, elm, k) => sum + (elm*B[k][j]) ,0)
		})
	})
}

function distance(lon2, lat2){
	const lon1 = 134;
	const lat1 = -24;
	const R = 6371;
	const phi1 = lat1 * Math.PI/180; // phi, lambda in radians
	const phi2 = lat2 * Math.PI/180;
	const Deltaphi = (lat2-lat1) * Math.PI/180;
	const Deltalambda = (lon2-lon1) * Math.PI/180;

	const a = Math.sin(Deltaphi/2) * Math.sin(Deltaphi/2) +
		Math.cos(phi1) * Math.cos(phi2) *
		Math.sin(Deltalambda/2) * Math.sin(Deltalambda/2);
	const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

	return R * c;
}

function bearing(lon2, lat2){
	lon2 = lon2 * Math.PI/180;
	lat2 = lat2 * Math.PI/180;
	const lon1 = 134 * Math.PI/180;
	const lat1 = -24 * Math.PI/180;
	const y = Math.sin(lon2-lon1) * Math.cos(lat2);
	const x = Math.cos(lat1)*Math.sin(lat2) -
		Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
	const Theta = Math.atan2(y, x);
	return (Theta + 2 * Math.PI) % (2 * Math.PI);
}

function get_coords(){
	const queryString = window.location;
	const re = /\?(\d+),(\d+)/;
	var xy = re.exec(queryString);
	if(!isCoastal([xy[1],xy[2]])){
		document.getElementById('longitude').value = '';
		document.getElementById('latitude').value = '';
	} else {
		const dX = 0.056355275878;
		const dY = -0.056406113854;
		const X = xy[1] * dX + 108.453169373447;
		const Y = xy[2] * dY - 6.075723287185;
		document.getElementById('longitude').value = X.toFixed(6);
		document.getElementById('latitude').value = Y.toFixed(6);
	}
}

function euclid(from,to){
	return Math.sqrt((from[0]-to[0])**2 + (from[1]-to[1])**2);
}

function isCoastal(point){
	var distances = coastal_coords.map(function(coord){return euclid(point, coord);});
	distances = distances.sort(function(a, b){return a-b});
	return distances[0] < 30 ? 1 : 0;
}
